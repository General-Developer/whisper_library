#!/bin/bash

export ANDROID_NDK=$HOME/Android/Sdk/ndk/27.2.12479018
ANDROID_ABIS="arm64-v8a armeabi-v7a x86 x86_64"

for ANDROID_ABI in $ANDROID_ABIS; do
    echo "Compile For Android $ANDROID_ABI"
    BASE_COMPILE_DIRECTORY="build-android-$ANDROID_ABI"
    BASE_WHISPER_CPP_COMPILE_DIRECTORY="$BASE_COMPILE_DIRECTORY/whisper.cpp"
    BASE_PREBUILT_DIRECTORY="prebuilt/android/$ANDROID_ABI"
    cmake -B $BASE_COMPILE_DIRECTORY -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK}/build/cmake/android.toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DANDROID_ABI=$ANDROID_ABI -DANDROID_PLATFORM=android-23
    cmake --build $BASE_COMPILE_DIRECTORY -j $(nproc)
    rm -rf $BASE_PREBUILT_DIRECTORY
    mkdir -p $BASE_PREBUILT_DIRECTORY
    cp -rf $BASE_WHISPER_CPP_COMPILE_DIRECTORY/src/lib*.so $BASE_PREBUILT_DIRECTORY
    cp -rf $BASE_WHISPER_CPP_COMPILE_DIRECTORY/src/lib*.so.* $BASE_PREBUILT_DIRECTORY
    cp -rf $BASE_WHISPER_CPP_COMPILE_DIRECTORY/ggml/src/lib*.so $BASE_PREBUILT_DIRECTORY
    rm -rf $BASE_COMPILE_DIRECTORY
done
